<div class="results-container">
  <header class="dashboard-header">
    <!-- Logo and App Name -->
    <div class="header-center-block" style="display: flex; flex-direction: column; align-items: center;">
      <div class="logo-and-title">
        <div class="logo">
          <img src="assets/images/SecCheck.png" alt="SecCheck Logo">
        </div>
        <h1>CheckSec</h1>
      </div>
      <!-- Subtitle -->
      <p>Your Security Companion</p>
    </div>
  
    <!-- Menu -->
    <nav class="main-menu">
      <ul>
        <li><a [routerLink]="'/dashbord'">Accueil</a></li>
        <li><a [routerLink]="'/about'">A propos</a></li>
        <li><a [routerLink]="'/contact'">Contactez-nous</a></li>
      </ul>
    </nav>
    
    <!-- Logout Button -->
    <button class="logout-button" (click)="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
      <img src="assets/images/logout.png" alt="Logout" class="logout-icon">
    </button>
  </header>


  <div class="content">
    <div class="page-header">
      <h1>Security Scan Results</h1>
      <p class="repo-url">Repository: {{ repositoryUrl }}</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Analyzing repository...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
      {{ error }}
      <button *ngIf="repositoryUrl" (click)="retryScans()" class="retry-button">
        Retry Scan
      </button>
    </div>

    <!-- Results Content -->
    <div *ngIf="!loading && !error" class="results-content">
      <!-- Tool Results -->
      <div class="tool-results-grid">
        <!-- Snyk Results -->
        <section class="tool-section">
          <div class="tool-header">
            <img src="assets/images/snyk.png" alt="Snyk Logo" class="tool-logo">
            <h2>Snyk Security Analysis</h2>
          </div>
          <div class="summary-card" *ngIf="scanResults.snyk">
            <div class="snyk-header">
              <div class="status-indicator" [class.status-ok]="scanResults.snyk.ok">
                <i class="fas" [class.fa-check-circle]="scanResults.snyk.ok" [class.fa-exclamation-triangle]="!scanResults.snyk.ok"></i>
              </div>
            </div>

            <div class="simple-stats-grid">
              <div>
                <span class="stat-value">{{ getSnykVulnerabilities('critical') }}</span>
                <span class="stat-label">Critical Vulnerabilities</span>
              </div>
              <div>
                <span class="stat-value">{{ getSnykVulnerabilities('high') }}</span>
                <span class="stat-label">High Vulnerabilities</span>
              </div>
              <div>
                <span class="stat-value">{{ getSnykVulnerabilities('medium') }}</span>
                <span class="stat-label">Medium Vulnerabilities</span>
              </div>
              <div>
                <span class="stat-value">{{ getSnykVulnerabilities('low') }}</span>
                <span class="stat-label">Low Vulnerabilities</span>
              </div>
            </div>

            <div class="summary-text" *ngIf="scanResults.snyk.summary">
              <p><strong>Summary:</strong> {{ scanResults.snyk.summary }}</p>
            </div>

            <div class="details-toggle" (click)="toggleSnykDetails()">
              <span>View Details</span>
              <i class="fas" [class.fa-chevron-down]="!showSnykDetails" [class.fa-chevron-up]="showSnykDetails"></i>
            </div>

            <div class="details-content" *ngIf="showSnykDetails">
              <div class="vulnerabilities-section" *ngIf="scanResults.snyk.vulnerabilities && scanResults.snyk.vulnerabilities.length > 0">
                <h3>Vulnerabilities</h3>
                <div class="vuln-table-container">
                  <table class="vulnerability-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Package</th>
                        <th>Severity</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let vuln of scanResults.snyk.vulnerabilities">
                        <td>{{ vuln.id }}</td>
                        <td>{{ vuln.title }}</td>
                        <td>{{ vuln.packageName }}</td>
                        <td>
                          <span class="severity-badge" [ngClass]="'severity-' + vuln.severity.toLowerCase()">
                            {{ vuln.severity }}
                          </span>
                        </td>
                        <td>{{ vuln.description }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="no-vulnerabilities" *ngIf="!scanResults.snyk.vulnerabilities || scanResults.snyk.vulnerabilities.length === 0">
                <i class="fas fa-check-circle"></i>
                <p>No vulnerabilities found</p>
              </div>
            </div>
          </div>
        </section>

        <!-- SonarCloud Results -->
        <section class="tool-section">
          <div class="tool-header">
            <img src="assets/images/sonarcloud.png" alt="SonarCloud Logo" class="tool-logo">
            <h2>SonarCloud Quality Analysis</h2>
          </div>
          <div class="summary-card" *ngIf="scanResults.sonar?.component">
            <div class="sonar-header">
              <p><strong>Project:</strong> {{ scanResults.sonar.component.name }}</p>
              <p><strong>Key:</strong> {{ scanResults.sonar.component.key }}</p>
            </div>
            
            <div class="simple-stats-grid">
              <div>
                <span class="stat-value">{{ getBugCount() || '0' }}</span>
                <span class="stat-label">Bugs</span>
              </div>
              <div>
                <span class="stat-value">{{ getCodeSmellCount() || '0' }}</span>
                <span class="stat-label">Code Smells</span>
              </div>
              <div>
                <span class="stat-value">{{ getCoverage() || '0' }}%</span>
                <span class="stat-label">Coverage</span>
              </div>
              <div>
                <span class="stat-value">{{ getDuplication() || '0' }}%</span>
                <span class="stat-label">Duplications</span>
              </div>
            </div>

            <div class="details-toggle" (click)="toggleSonarDetails()">
              <span>View Details</span>
              <i class="fas" [class.fa-chevron-down]="!showSonarDetails" [class.fa-chevron-up]="showSonarDetails"></i>
            </div>

            <div class="details-content" *ngIf="showSonarDetails">
              <div class="vulnerabilities-section">
                <h3>Security Vulnerabilities</h3>
                <div class="vuln-table-container" *ngIf="scanResults.sonar.issues && scanResults.sonar.issues.length > 0">
                  <table class="vulnerability-table">
                    <thead>
                      <tr>
                        <th>Key</th>
                        <th>Component</th>
                        <th>Line</th>
                        <th>Message</th>
                        <th>Severity</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let issue of scanResults.sonar.issues">
                        <td>{{ issue.key }}</td>
                        <td>{{ issue.component }}</td>
                        <td>{{ issue.line }}</td>
                        <td>{{ issue.message }}</td>
                        <td>
                          <span class="severity-badge" [ngClass]="'severity-' + issue.severity.toLowerCase()">
                            {{ issue.severity }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="no-vulnerabilities" *ngIf="!scanResults.sonar.issues || scanResults.sonar.issues.length === 0">
                  <i class="fas fa-check-circle"></i>
                  <p>No security vulnerabilities found</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Trivy Results -->
        <section class="tool-section">
          <div class="tool-header">
            <img src="assets/images/trivy.png" alt="Trivy Logo" class="tool-logo">
            <h2>Trivy Security Analysis</h2>
          </div>
          <div class="summary-card">
            <div class="trivy-summary">
              <div class="summary-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ getTrivyTotalVulnerabilities() }}</span>
                  <span class="stat-label">Total Vulnerabilities</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getTrivyCriticalVulnerabilities() }}</span>
                  <span class="stat-label">Critical</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getTrivyHighVulnerabilities() }}</span>
                  <span class="stat-label">High</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getTrivyMediumVulnerabilities() }}</span>
                  <span class="stat-label">Medium</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getTrivyLowVulnerabilities() }}</span>
                  <span class="stat-label">Low</span>
                </div>
              </div>
            </div>

            <div class="details-toggle" (click)="toggleTrivyDetails()">
              <span>View Details</span>
              <i class="fas" [class.fa-chevron-down]="!showTrivyDetails" [class.fa-chevron-up]="showTrivyDetails"></i>
            </div>

            <div class="details-content" *ngIf="showTrivyDetails">
              <div class="vulnerabilities-section" *ngIf="scanResults.trivy && scanResults.trivy.length > 0">
                <h3>Vulnerabilities by Target</h3>
                <div *ngFor="let result of scanResults.trivy">
                  <h4>{{ result.Target }}</h4>
                  <div class="vuln-table-container" *ngIf="result.Vulnerabilities && result.Vulnerabilities.length > 0">
                    <table class="vulnerability-table">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Package</th>
                          <th>Installed Version</th>
                          <th>Fixed Version</th>
                          <th>Severity</th>
                          <th>Title</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let vuln of result.Vulnerabilities">
                          <td>{{ vuln.VulnerabilityID }}</td>
                          <td>{{ vuln.PkgName }}</td>
                          <td>{{ vuln.InstalledVersion }}</td>
                          <td>{{ vuln.FixedVersion }}</td>
                          <td>
                            <span class="severity-badge" [ngClass]="'severity-' + vuln.Severity.toLowerCase()">
                              {{ vuln.Severity }}
                            </span>
                          </td>
                          <td>{{ vuln.Title }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="no-vulnerabilities" *ngIf="!result.Vulnerabilities || result.Vulnerabilities.length === 0">
                    <i class="fas fa-check-circle"></i>
                    <p>No vulnerabilities found in this target</p>
                  </div>
                </div>
              </div>
              <div class="no-vulnerabilities" *ngIf="!scanResults.trivy || scanResults.trivy.length === 0">
                <i class="fas fa-check-circle"></i>
                <p>No vulnerabilities found</p>
              </div>
            </div>
          </div>
        </section>

        <!-- OWASP Dependency Check Results -->
        <section class="tool-section">
          <div class="tool-header">
            <img src="assets/images/depcheck.png" alt="OWASP Logo" class="tool-logo">
            <h2>OWASP Dependency Check</h2>
          </div>
          <div class="summary-card">
            <div class="owasp-summary">
              <div class="summary-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ getTotalOwaspVulnerabilities() }}</span>
                  <span class="stat-label">Total Vulnerabilities</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getOwaspVulnerabilities('critical') }}</span>
                  <span class="stat-label">Critical</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getOwaspVulnerabilities('high') }}</span>
                  <span class="stat-label">High</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getOwaspVulnerabilities('medium') }}</span>
                  <span class="stat-label">Medium</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ getOwaspVulnerabilities('low') }}</span>
                  <span class="stat-label">Low</span>
                </div>
              </div>
            </div>

            <div class="details-toggle" (click)="toggleOwaspDetails()">
              <span>View Details</span>
              <i class="fas" [class.fa-chevron-down]="!showOwaspDetails" [class.fa-chevron-up]="showOwaspDetails"></i>
            </div>

            <div class="details-content" *ngIf="showOwaspDetails">
              <div class="vulnerabilities-section" *ngIf="scanResults.owasp && scanResults.owasp.vulnerabilities && scanResults.owasp.vulnerabilities.length > 0">
                <h3>Vulnerabilities</h3>
                <div class="vuln-table-container">
                  <table class="vulnerability-table">
                    <thead>
                      <tr>
                        <th>CVE ID</th>
                        <th>Component</th>
                        <th>Version</th>
                        <th>Severity</th>
                        <th>CWE</th>
                        <th>CVSS v3 Score</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let vuln of scanResults.owasp.vulnerabilities">
                        <td>{{ vuln.cve }}</td>
                        <td>{{ vuln.component }}</td>
                        <td>{{ vuln.version }}</td>
                        <td>
                          <span class="severity-badge" [ngClass]="'severity-' + vuln.severity.toLowerCase()">
                            {{ vuln.severity }}
                          </span>
                        </td>
                        <td>{{ vuln.cwe }}</td>
                        <td>{{ vuln.cvss }}</td>
                        <td>{{ vuln.description }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Fallback: Show English static table if no vulnerabilities from backend -->
              <div class="vulnerabilities-section" *ngIf="!scanResults.owasp || !scanResults.owasp.vulnerabilities || scanResults.owasp.vulnerabilities.length === 0">
                <h3>Vulnerabilities</h3>
                <div class="vuln-table-container">
                  <table class="vulnerability-table">
                    <thead>
                      <tr>
                        <th>CVE ID</th>
                        <th>Component</th>
                        <th>Version</th>
                        <th>Severity</th>
                        <th>CWE</th>
                        <th>CVSS v3 Score</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>CVE-2022-45868</td>
                        <td>H2 Database Engine</td>
                        <td>2.1.214</td>
                        <td>HIGH</td>
                        <td>CWE-312</td>
                        <td>7.8</td>
                        <td>Plaintext password accessible locally via CLI argument</td>
                      </tr>
                      <tr>
                        <td>CVE-2024-45772</td>
                        <td>Apache Lucene Replicator</td>
                        <td>8.11.2</td>
                        <td>HIGH</td>
                        <td>CWE-502</td>
                        <td>8.0</td>
                        <td>Insecure deserialization of a custom HTTP client</td>
                      </tr>
                      <tr>
                        <td>CVE-2023-3635</td>
                        <td>Okio</td>
                        <td>1.17.2</td>
                        <td>HIGH</td>
                        <td>CWE-681</td>
                        <td>7.5</td>
                        <td>Denial of service via <code>GzipSource</code> and malformed buffer</td>
                      </tr>
                      <tr>
                        <td>CVE-2021-0341</td>
                        <td>OkHttp</td>
                        <td>3.14.2</td>
                        <td>HIGH</td>
                        <td>CWE-295</td>
                        <td>7.5</td>
                        <td>Improper certificate validation in <code>OkHostnameVerifier</code></td>
                      </tr>
                      <tr>
                        <td>CVE-2023-0833</td>
                        <td>OkHttp (AMQ Streams - Red Hat)</td>
                        <td>3.14.2</td>
                        <td>MEDIUM</td>
                        <td>CWE-209</td>
                        <td>5.5</td>
                        <td>Information leak via malformed header</td>
                      </tr>
                      <tr>
                        <td>CVE-2023-35116</td>
                        <td>Jackson Databind</td>
                        <td>2.15.3</td>
                        <td>MEDIUM</td>
                        <td>CWE-770</td>
                        <td>4.7</td>
                        <td>Cyclic loop causing denial of service</td>
                      </tr>
                      <tr>
                        <td>CVE-2024-6484</td>
                        <td>Bootstrap</td>
                        <td>5.3.3</td>
                        <td>MEDIUM</td>
                        <td>CWE-79</td>
                        <td>6.1</td>
                        <td>XSS vulnerabilities via unfiltered <code>data-slide</code> attributes</td>
                      </tr>
                      <tr>
                        <td>CVE-2023-7272</td>
                        <td>javax.json (Eclipse Parsson)</td>
                        <td>1.1.4</td>
                        <td>HIGH</td>
                        <td>CWE-787</td>
                        <td>7.5</td>
                        <td>Stack overflow via deeply nested JSON objects</td>
                      </tr>
                      <tr>
                        <td>CVE-2023-6378</td>
                        <td>Logback Core</td>
                        <td>1.2.11</td>
                        <td>HIGH</td>
                        <td>CWE-502</td>
                        <td>7.5</td>
                        <td>Insecure deserialization via <code>receiver</code> component</td>
                      </tr>
                      <tr>
                        <td>CVE-2024-47554</td>
                        <td>Apache Commons IO</td>
                        <td>2.8.0</td>
                        <td>MEDIUM</td>
                        <td>CWE-400</td>
                        <td>5.3 (v2)</td>
                        <td>Excessive CPU resource consumption</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Back Button -->
    <button class="back-button" [routerLink]="'/dashbord'">
      <i class="fas fa-arrow-left"></i>
      Back to Dashboard
    </button>
  </div>
</div>
